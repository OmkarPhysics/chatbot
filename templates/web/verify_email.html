{% extends "web/base.html" %}
{% block title %}Verify email{% endblock %}
{% block content %}
  <div class="card p-4 mb-4">
    <h2>Verify email (OTP)</h2>
    <div id="alert-box" class="alert d-none" role="alert"></div>
    <div class="mb-3">
      <label class="form-label">Email</label>
      <input id="email" type="email" class="form-control" />
    </div>
    <div class="mb-3">
      <label class="form-label">OTP</label>
      <input id="otp" type="text" class="form-control" />
    </div>
    <div class="d-flex gap-2 mt-3">
      <button type="button" class="btn btn-primary" onclick="doVerify()">Verify</button>
      <button type="button" class="btn btn-outline-secondary" onclick="doResendOTP()">Resend OTP</button>
    </div>
    <pre id="out" class="mt-3">{}</pre>
  </div>
{% endblock %}
{% block scripts %}
  <script>
    // Pre-fill email from URL query parameter
    const params = new URLSearchParams(window.location.search);
    if (params.get("email")) {
      document.getElementById("email").value = params.get("email");
    }

    function showAlert(message, type = "warning") {
      const alertBox = document.getElementById("alert-box");
      alertBox.className = `alert alert-${type}`;
      alertBox.innerHTML = message;
      alertBox.classList.remove("d-none");
    }

    function hideAlert() {
      document.getElementById("alert-box").classList.add("d-none");
    }

    async function doVerify() {
      hideAlert();
      const email = document.getElementById("email").value;
      const body = {
        email: email,
        otp: document.getElementById("otp").value,
      };
      const res = await api("/api/auth/verify-email/", { method: "POST", body });
      show("out", res.json ?? res.text);
      if (res.ok) {
        showAlert("Email verified successfully! Redirecting to login...", "success");
        setTimeout(() => {
          window.location.href = "/login/?email=" + encodeURIComponent(email);
        }, 1500);
      } else {
        const errorStr = JSON.stringify(res.json ?? res.text).toLowerCase();
        if (errorStr.includes("expired")) {
          showAlert('OTP has expired. Click "Resend OTP" to get a new one.', "warning");
        } else if (errorStr.includes("no active otp") || errorStr.includes("no user found")) {
          showAlert('No active OTP found. Click "Resend OTP" or <a href="/register/" class="alert-link">register again</a>.', "warning");
        } else if (errorStr.includes("invalid otp")) {
          showAlert("Invalid OTP. Please check the code and try again.", "danger");
        }
      }
    }

    async function doResendOTP() {
      hideAlert();
      const email = document.getElementById("email").value;
      if (!email) {
        showAlert("Please enter your email address first.", "warning");
        return;
      }
      const res = await api("/api/auth/resend-otp/", { method: "POST", body: { email } });
      show("out", res.json ?? res.text);
      if (res.ok) {
        showAlert("New OTP sent! Please check your email.", "success");
        document.getElementById("otp").value = "";
      } else {
        const errorStr = JSON.stringify(res.json ?? res.text).toLowerCase();
        if (errorStr.includes("already verified")) {
          showAlert('Email is already verified. <a href="/login/?email=' + encodeURIComponent(email) + '" class="alert-link">Login here</a>.', "info");
        } else if (errorStr.includes("no user found")) {
          showAlert('No user found for this email. <a href="/register/" class="alert-link">Register here</a>.', "warning");
        } else {
          showAlert("Failed to resend OTP. Please try again.", "danger");
        }
      }
    }
  </script>
{% endblock %}
